<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>é“¾æ¥ç²¾ç®€å™¨ | æç®€çŸ­é“¾</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- å¼•ç”¨é€šç”¨çš„æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="style.css" />

    <!-- æœ¬é¡µé¢ç‰¹æœ‰çš„æ ·å¼ -->
    <style>
      /* é¡¶éƒ¨å¤§å›¾æ ‡åŒºåŸŸ */
      .card-header-center {
        text-align: center;
        margin-bottom: 30px;
      }
      .icon-box-lg {
        width: 70px;
        height: 70px;
        background: var(--primary-gradient);
        border-radius: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        color: white;
        margin: 0 auto 15px;
        box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
      }

      /* è¡¨å•å¸ƒå±€ï¼šä¸¤åˆ—å¹¶æ’ */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      /* å†å²è®°å½•å¡ç‰‡æ ·å¼ */
      .link-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: transform 0.2s;
        position: relative;
        overflow: hidden;
        margin-bottom: 15px;
        box-shadow: var(--shadow);
      }
      .link-card:hover {
        transform: translateY(-3px);
      }

      .link-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .short-url {
        font-weight: 700;
        color: var(--accent-color);
        font-size: 1.1rem;
      }

      .original-url {
        font-size: 0.8rem;
        color: var(--text-sub);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background: rgba(0, 0, 0, 0.03);
        padding: 5px 10px;
        border-radius: 8px;
      }

      .link-actions {
        display: flex;
        gap: 8px;
        margin-top: 5px;
      }

      /* å°æŒ‰é’®æ ·å¼ */
      .action-btn-xs {
        padding: 6px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.2s;
      }
      .btn-copy {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }
      .btn-copy:hover {
        background: rgba(102, 126, 234, 0.2);
      }
      .btn-del {
        background: rgba(255, 71, 87, 0.1);
        color: #ff4757;
      }
      .btn-del:hover {
        background: rgba(255, 71, 87, 0.2);
      }

      /* é¡¶éƒ¨æ“ä½œå°æŒ‰é’® */
      .action-btn-sm {
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid var(--glass-border);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
      }
      .action-btn-sm.danger {
        color: #ff4757;
      }
      .action-btn-sm:hover {
        background: white;
        transform: translateY(-2px);
      }

      /* ç»“æœå¼¹çª—ç‰¹æœ‰æ ·å¼ */
      .result-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        color: white;
      }
      .result-icon.success {
        background: #2ecc71;
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
      }
      .highlight-url {
        background: #f0f2f5;
        padding: 10px;
        border-radius: 10px;
        font-family: monospace;
        margin: 15px 0;
        word-break: break-all;
        color: var(--accent-color);
        font-weight: 600;
      }

      @media (max-width: 480px) {
        .form-row {
          grid-template-columns: 1fr;
          gap: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loading-screen">
      <div class="loader-content">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆå§‹åŒ–...</p>
      </div>
    </div>

    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="bg-decoration">
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar glass-nav">
      <div class="nav-brand">
        <i class="fas fa-bolt"></i>
        <span>ShortLink</span>
      </div>
      <a href="index.html" class="logout-btn"><i class="fas fa-home"></i></a>
    </nav>

    <div class="container">
      <!-- ä¸»åŠŸèƒ½åŒº -->
      <div
        class="glass-card fade-in-up"
        style="padding: 30px; margin-bottom: 30px"
      >
        <div class="card-header-center">
          <div class="icon-box-lg"><i class="fas fa-link"></i></div>
          <h2>é“¾æ¥ç¼©çŸ­</h2>
          <p style="color: var(--text-sub)">è®©åˆ†äº«å˜å¾—æ›´ç®€å•</p>
        </div>

        <div class="shorten-form">
          <div class="input-group">
            <i class="fas fa-globe"></i>
            <input
              type="text"
              id="longURL"
              placeholder="ç²˜è´´é•¿é“¾æ¥ (ä¾‹å¦‚ https://...)"
              oninput="loadUrlList()"
            />
          </div>

          <div class="form-row">
            <div class="input-group">
              <i class="fas fa-tag"></i>
              <input
                type="text"
                id="keyPhrase"
                placeholder="è‡ªå®šä¹‰åç¼€ (å¯é€‰)"
              />
            </div>
            <div class="input-group">
              <i class="fas fa-key"></i>
              <!-- è¿™é‡Œçš„ value éœ€è¦å¡«ä½  Worker çš„å¯†ç ï¼Œå¦‚æœæ²¡å¯†ç å°±ç•™ç©º -->
              <input
                type="text"
                id="passwordText"
                placeholder="è®¿é—®å¯†ç "
                value="__PASSWORD__"
              />
            </div>
          </div>

          <button id="shorten-btn" class="btn-primary" onclick="shorturl()">
            <span>ç«‹å³ç”Ÿæˆ</span>
            <i class="fas fa-magic"></i>
          </button>
        </div>
      </div>

      <!-- å†å²è®°å½•åŒº -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
        class="fade-in-up delay-1"
      >
        <h3 class="section-title" style="margin: 0">æˆ‘çš„çŸ­é“¾</h3>
        <div class="quick-actions" style="display: flex; gap: 10px; margin: 0">
          <button class="action-btn-sm" onclick="loadUrlList()">
            <i class="fas fa-sync-alt"></i> åˆ·æ–°
          </button>
          <button class="action-btn-sm danger" onclick="clearLocalStorage()">
            <i class="fas fa-trash-alt"></i> æ¸…ç©º
          </button>
        </div>
      </div>

      <!-- çŸ­é“¾åˆ—è¡¨ -->
      <div id="urlList" class="fade-in-up delay-2"></div>

      <footer class="footer">
        <p>Â© 2025 Link Shortener Service</p>
      </footer>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div id="result-modal" class="modal">
      <div class="modal-content glass-card">
        <span class="close-modal" onclick="toggleModal('result-modal')"
          >&times;</span
        >
        <div class="result-icon success"><i class="fas fa-check"></i></div>
        <h3>ç”ŸæˆæˆåŠŸ!</h3>
        <p id="result-url" class="highlight-url">...</p>
        <button class="btn-primary" onclick="copyResult()">
          <i class="fas fa-copy"></i> å¤åˆ¶é“¾æ¥
        </button>
      </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ============================================
        // API é…ç½®
        // é»˜è®¤ç•™ç©ºå­—ç¬¦ä¸² ""ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰ç½‘é¡µçš„åŸŸåä½œä¸ºåå°ã€‚
        // å¦‚æœä½ åœ¨ GitHub Pages ä¸Šç‚¹ç”Ÿæˆæ²¡ååº”ï¼Œè¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Worker åœ°å€
        // ä¾‹å¦‚: "https://short.ä½ çš„åŸŸå.workers.dev"
        const API_URL = "";
        // ============================================

        const longUrlInput = document.getElementById("longURL");
        const keyPhraseInput = document.getElementById("keyPhrase");
        const passwordInput = document.getElementById("passwordText");
        const urlListContainer = document.getElementById("urlList");
        const loadingScreen = document.getElementById("loading-screen");
        const resultModal = document.getElementById("result-modal");
        const resultUrlText = document.getElementById("result-url");

        // åˆå§‹åŒ–åŠ è½½
        setTimeout(() => {
          loadingScreen.style.opacity = "0";
          loadingScreen.style.visibility = "hidden";
          loadUrlList();
        }, 500);

        // 1. ç”ŸæˆçŸ­é“¾æ ¸å¿ƒé€»è¾‘
        window.shorturl = async function () {
          const longURL = longUrlInput.value.trim();
          const keyPhrase = keyPhraseInput.value.trim();
          const password = passwordInput.value.trim();

          if (!longURL) {
            showToast("è¯·è¾“å…¥é•¿é“¾æ¥ ğŸ˜…");
            longUrlInput.focus();
            return;
          }

          // æŒ‰é’®åŠ è½½çŠ¶æ€
          const btn = document.getElementById("shorten-btn");
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div>';
          btn.disabled = true;

          try {
            // è‡ªåŠ¨åˆ¤æ–­è¯·æ±‚åœ°å€ï¼šå¦‚æœæœ‰é…ç½®å°±ç”¨é…ç½®ï¼Œæ²¡é…ç½®å°±ç”¨å½“å‰åŸŸå
            const targetUrl = API_URL ? API_URL : window.location.origin;

            const response = await fetch(targetUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                url: longURL,
                slug: keyPhrase,
                password: password,
              }),
            });

            const data = await response.json();

            // Worker è¿”å›çš„æ ¼å¼é€šå¸¸æ˜¯ {status:200, key: "...", slug: "..."} æˆ–è€… {shorturl: "..."}
            // è¿™é‡Œåšä¸€äº›å…¼å®¹å¤„ç†
            if (response.ok && (data.status === 200 || data.shorturl)) {
              const shortUrl = data.shorturl || targetUrl + "/" + data.key;

              saveToLocal(data.key || data.slug, longURL, shortUrl);

              resultUrlText.textContent = shortUrl;
              toggleModal("result-modal");
              loadUrlList();

              longUrlInput.value = "";
              keyPhraseInput.value = "";
            } else {
              showToast(
                "é”™è¯¯: " + (data.message || "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æˆ–åç¼€")
              );
            }
          } catch (error) {
            console.error(error);
            showToast("è¯·æ±‚å¤±è´¥ï¼å¦‚æœæ‚¨åœ¨GitHub Pagesï¼Œè¯·é…ç½®APIåœ°å€");
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        };

        // 2. æœ¬åœ°å­˜å‚¨é€»è¾‘
        function saveToLocal(slug, longURL, shortURL) {
          let list = JSON.parse(localStorage.getItem("short_urls")) || [];
          list = list.filter((item) => item.slug !== slug);
          list.unshift({ slug, longURL, shortURL, date: new Date().getTime() });
          localStorage.setItem("short_urls", JSON.stringify(list));
        }

        // 3. æ¸²æŸ“åˆ—è¡¨
        window.loadUrlList = function () {
          const list = JSON.parse(localStorage.getItem("short_urls")) || [];
          urlListContainer.innerHTML = "";

          if (list.length === 0) {
            urlListContainer.innerHTML = `
                        <div style="text-align:center;color:#999;padding:40px;">
                            <i class="fas fa-inbox" style="font-size:3rem;margin-bottom:15px;opacity:0.5;"></i>
                            <p>æš‚æ— ç”Ÿæˆè®°å½•</p>
                        </div>`;
            return;
          }

          list.forEach((item) => {
            const card = document.createElement("div");
            card.className = "link-card fade-in-up";
            card.innerHTML = `
                        <div class="link-header">
                            <span class="short-url">${item.shortURL}</span>
                            <button class="action-btn-xs btn-del" onclick="deleteShortUrl('${item.slug}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="original-url" title="${item.longURL}">${item.longURL}</div>
                        <div class="link-actions">
                            <button class="action-btn-xs btn-copy" onclick="copyText('${item.shortURL}')">
                                <i class="fas fa-copy"></i> å¤åˆ¶
                            </button>
                            <a href="${item.shortURL}" target="_blank" class="action-btn-xs" style="background:rgba(0,0,0,0.05);color:#555;text-decoration:none;">
                                <i class="fas fa-external-link-alt"></i> è®¿é—®
                            </a>
                        </div>
                    `;
            urlListContainer.appendChild(card);
          });
        };

        // 4. åˆ é™¤å’Œæ¸…ç©º
        window.deleteShortUrl = function (slug) {
          if (!confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ")) return;
          let list = JSON.parse(localStorage.getItem("short_urls")) || [];
          list = list.filter((item) => item.slug !== slug);
          localStorage.setItem("short_urls", JSON.stringify(list));
          loadUrlList();
        };

        window.clearLocalStorage = function () {
          if (!confirm("æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ")) return;
          localStorage.removeItem("short_urls");
          loadUrlList();
        };

        // 5. å¤åˆ¶å’Œå¼¹çª—
        window.copyText = function (text) {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand("copy");
            showToast("å¤åˆ¶æˆåŠŸï¼");
          } catch (err) {
            showToast("å¤åˆ¶å¤±è´¥");
          }
          document.body.removeChild(textArea);
        };

        window.copyResult = function () {
          copyText(resultUrlText.textContent);
        };

        window.toggleModal = function (modalId) {
          const modal = document.getElementById(modalId);
          modal.style.display =
            modal.style.display === "flex" ? "none" : "flex";
        };

        function showToast(msg) {
          const toast = document.getElementById("toast");
          const toastMsg = document.getElementById("toast-msg");
          toastMsg.textContent = msg;
          toast.classList.add("show");
          setTimeout(() => toast.classList.remove("show"), 2000);
        }

        window.onclick = function (event) {
          if (event.target.classList.contains("modal"))
            event.target.style.display = "none";
        };
      });
    </script>
  </body>
</html>
